<script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwr_vi5RnGrsvkHCEM6SQt63_ThvZ8QH_fv91731LJdFzdCBAcED6jandGo1oOl79hosA/exec';
        const studentId = localStorage.getItem('studentId') || 'Anonymous';
        let selectedWordElement = null;
        let userColor = "Blue";

        function logData(action, result, isCorrect) {
            const data = { 
                studentId: studentId, 
                activity: 'Sentence Building', 
                action: action, 
                result: result,
                isCorrect: isCorrect 
            };
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .catch(err => console.error('Log Error:', err));
        }

        function startGame() {
            const input = document.getElementById('user-color-input');
            if (input.value.trim() !== "") {
                userColor = input.value.trim();
            }
            logData('Input Color', userColor, 'N/A'); // 輸入顏色沒有對錯
            document.getElementById('start-modal').style.display = 'none';
            initWordBank();
        }

        function initWordBank() {
            const bank = document.getElementById('word-bank');
            let words = ["My", "favorite", "color", "is", userColor];
            for (let i = words.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [words[i], words[j]] = [words[j], words[i]];
            }
            words.forEach(word => {
                const div = document.createElement('div');
                div.className = 'word-card';
                div.textContent = word;
                div.onclick = function(e) { selectWord(e, this); };
                bank.appendChild(div);
            });
        }

        function selectWord(event, element) {
            event.stopPropagation();
            if (selectedWordElement === element) {
                element.classList.remove('selected');
                selectedWordElement = null;
                return;
            }
            if (selectedWordElement) {
                selectedWordElement.classList.remove('selected');
            }
            selectedWordElement = element;
            element.classList.add('selected');
        }

        function placeWord(slotIndex) {
            const slots = document.querySelectorAll('.slot');
            const targetSlot = slots[slotIndex];

            if (selectedWordElement) {
                if (targetSlot.children.length > 0) {
                    const oldWordDiv = targetSlot.firstElementChild;
                    createCardInBank(oldWordDiv.textContent);
                    targetSlot.innerHTML = '';
                }
                const textDiv = document.createElement('div');
                textDiv.className = 'slot-text';
                textDiv.textContent = selectedWordElement.textContent;
                targetSlot.appendChild(textDiv);
                selectedWordElement.remove();
                selectedWordElement = null;
                checkSentence();
            } else {
                if (targetSlot.children.length > 0) {
                    const text = targetSlot.firstElementChild.textContent;
                    createCardInBank(text);
                    targetSlot.innerHTML = '';
                    checkSentence();
                }
            }
        }

        function createCardInBank(text) {
            const bank = document.getElementById('word-bank');
            const div = document.createElement('div');
            div.className = 'word-card';
            div.textContent = text;
            div.onclick = function(e) { selectWord(e, this); };
            bank.appendChild(div);
        }

        function checkSentence() {
            const slots = document.querySelectorAll('.slot');
            let filledCount = 0;
            let currentSentence = [];

            slots.forEach(slot => {
                if (slot.children.length > 0) {
                    filledCount++;
                    currentSentence.push(slot.firstElementChild.textContent);
                }
            });

            const doneBtn = document.getElementById('done-btn');

            if (filledCount === 5) {
                let isCorrect = true;
                if (currentSentence[0] !== "My") isCorrect = false;
                if (currentSentence[1] !== "favorite") isCorrect = false;
                if (currentSentence[2] !== "color") isCorrect = false;
                if (currentSentence[3] !== "is") isCorrect = false;
                if (currentSentence[4].toLowerCase() !== userColor.toLowerCase()) isCorrect = false;

                if (isCorrect) {
                    // 這裡記錄 Yes
                    logData('Check Order', 'Correct Sentence', 'Yes');
                    slots.forEach(slot => slot.style.backgroundColor = "#e6fffa");
                    
                    doneBtn.textContent = "FINISH ALL ACTIVITIES!";
                    doneBtn.style.display = "block";
                    doneBtn.onclick = function() {
                        logData('Session', 'Lesson Completed', 'Yes');
                        alert("Congratulations! You have completed the entire lesson.");
                    };
                } else {
                    // 這裡記錄 No
                    logData('Check Order', 'Incorrect Order', 'No');
                    slots.forEach(slot => slot.style.backgroundColor = "#fff0f0");
                    doneBtn.style.display = "none";
                }
            } else {
                slots.forEach(slot => slot.style.backgroundColor = "white");
                doneBtn.style.display = "none";
            }
        }
    </script>
